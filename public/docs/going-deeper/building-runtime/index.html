<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="apple-touch-icon" sizes="120x120" href="https://mindfreeze.videolan.me/rav1e/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://mindfreeze.videolan.me/rav1e/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://mindfreeze.videolan.me/rav1e/favicon-16x16.png">
    <link rel="manifest" href="https://mindfreeze.videolan.me/rav1e/manifest.json">
    <link rel="mask-icon" href="https://mindfreeze.videolan.me/rav1e/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="https://mindfreeze.videolan.me/rav1e/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="https://mindfreeze.videolan.me/rav1e/css/bootstrap.css">
    <link rel="stylesheet" href="https://mindfreeze.videolan.me/rav1e/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://mindfreeze.videolan.me/rav1e/css/rav1e.css">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/>

    
    <link rel="alternate" type="application/rss+xml" href="https://tokio.rs/blog/index.xml" />

    <title>
      
        Building a runtime - rav1e
      
    </title>
  </head>
  <body>
    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row tk-navbar">
      <a class="navbar-brand" href="https://mindfreeze.videolan.me/rav1e/">
        <img src="https://mindfreeze.videolan.me/rav1e/img/logo.png" class="align-middle" alt="">
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link " href="https://mindfreeze.videolan.me/rav1e/">Home</a>
          </li>
          <li class="nav-item">
            
            
            
            <a class="nav-link  active " href="https://mindfreeze.videolan.me/rav1e/docs/getting-started/hello-world/">Documentation</a>
          </li>
          <li class="nav-item">
            
            <a class="nav-link " href="https://mindfreeze.videolan.me/rav1e/community/">Community</a>
          </li>
          <li class="nav-item">
            
            
            <a class="nav-link " href="https://mindfreeze.videolan.me/rav1e/blog/2018-12-recap-2018/">Blog</a>
          </li>
        </ul>
      </div>

      <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
        <li class="nav-item">
          <a class="nav-link p-2" href="https://github.com/xiph/rav1e" target="_blank" rel="noopener" aria-label="GitHub">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64 0 0 114.61 0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34 0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49 0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75 0 0 21.49-6.88 70.4 26.24a242.65 242.65 0 0 1 128.18 0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69 0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41 0 34.22-.31 61.83-.31 70.23 0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37 0 256 0z" fill="currentColor" fill-rule="evenodd"/></svg>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link p-2" href="https://gitter.im/tokio-rs/tokio" target="_blank" rel="noopener" aria-label="Gitter">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Gitter</title><path fill="currentColor" d="M8.501 4.001H10.5V24H8.501V4.001zm6.999 0V24h-2V4.001h2zM3.5 0h2.001v15H3.5V0zm15 4.001h2V15h-2V4.001z"/></svg>
          </a>
        </li>
      </ul>
    </header>



<div class="container-fluid tk-docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 tk-sidebar">
      <form class="tk-search d-flex align-items-center">
        <span class="algolia-autocomplete algolia-autocomplete-left" style="position: relative; display: inline-block; direction: ltr;">
          <input class="form-control ds-input" id="search-input" placeholder="Search..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" style="position: relative; vertical-align: top;" dir="auto" type="search">
          <pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-size: 16px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: optimizelegibility; text-transform: none;">w</pre>
          <span class="ds-dropdown-menu ds-with-1" style="position: absolute; top: 100%; left: 0px; z-index: 100; right: auto; display: none;" role="listbox" id="algolia-autocomplete-listbox-0">
            <div class="ds-dataset-1"></div>
          </span>
        </span>
        <button class="btn btn-link tk-search-docs-toggle d-md-none p-0 ml-3" type="button" data-toggle="collapse" data-target="#tk-docs-nav" aria-controls="tk-docs-nav" aria-expanded="false" aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false">
            <title>Menu</title><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"></path></svg>
        </button>
      </form>

      <nav class="tk-links collapse" id="tk-docs-nav">
          
          
            
              <div class="tk-toc-item">
                <a class="tk-toc-link" href="https://mindfreeze.videolan.me/rav1e/docs/overview/">
                  What is Tokio?
                </a>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://mindfreeze.videolan.me/rav1e/docs/getting-started/hello-world/">
                  Getting started
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/getting-started/hello-world/" class="">Hello World!</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/getting-started/futures/" class="">Futures</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/getting-started/runtime/" class="">Runtime</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/getting-started/echo/" class="">Example: An Echo Server</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://mindfreeze.videolan.me/rav1e/docs/futures/overview/">
                  Working with futures
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/overview/" class="">Overview</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/basic/" class="">Implementing futures</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/getting_asynchronous/" class="">Getting asynchronous</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/combinators/" class="">Combinators</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/streams/" class="">Streams</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/spawning/" class="">Spawning</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/leaf-futures/" class="">Leaf futures</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/futures/runtime-model/" class="">Runtime model</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://mindfreeze.videolan.me/rav1e/docs/io/overview/">
                  I/O with Tokio
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/io/overview/" class="">I/O Overview</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/io/reading_writing_data/" class="">Reading and Writing Data</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/io/async_read_write/" class="">Using AsyncRead and AsyncWrite directly</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/io/impl_async_read_write/" class="">Implementing Async Read/Write</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/io/filesystem/" class="">Filesystem APIs</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/io/datagrams/" class="">Datagram APIs</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item active">
                <a class="tk-toc-link" href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/futures/">
                  Going deeper
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/futures/" class="">Futures: In Depth</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/tasks/" class="">Tasks</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/runtime-model/" class="">Runtime Model</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/io/" class="">I/O with Tokio</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/chat/" class="">Example: A Chat Server</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/timers/" class="">Timers</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/futures-mechanics/" class="">Essential combinators</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/returning/" class="">Returning futures</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/frames/" class="">Working with framed streams</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/going-deeper/building-runtime/" class="active">Building a runtime</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://mindfreeze.videolan.me/rav1e/docs/internals/intro/">
                  Tokio internals
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/internals/intro/" class="">Introduction</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/internals/runtime-model/" class="">Runtime model</a></li>
                
                  <li><a href="https://mindfreeze.videolan.me/rav1e/docs/internals/net/" class="">Non-blocking I/O</a></li>
                
                </ul>
              </div>
            
          
            
              <div class="tk-toc-item">
                <a class="tk-toc-link" href="https://docs.rs/tokio">
                  API documentation
                </a>
              </div>
            
          
      </nav>
    </div>
    <div class="d-none d-xl-block col-xl-2 tk-toc">
      <div class="section-nav">
        <nav id="TableOfContents">
<ul>
<li><a href="#the-park-trait">The <code>Park</code> trait</a></li>
<li><a href="#the-usual-components">The usual components</a></li>
<li><a href="#global-state">Global state</a></li>
</ul>
</nav>
      </div>
    </div>
    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 tk-content tk-docs">
      <h1 class="tk-title">Building a runtime</h1>
      <div class="github-edit">
        <a class="fa fa-github" href="https://github.com/tokio-rs/website/tree/master/content/docs/going-deeper/building-runtime.md"> Edit on GitHub</a>
      </div>
      

<p>The runtime ‒ all the pieces needed to run an event driven application ‒ is
already available. You don&rsquo;t <em>need</em> to know this if you want to just use tokio.
However, it may be useful to know what happens under the hood, both to gain some
more understanding of the details in case something goes wrong, and to be able
to customize it beyond what the <a href="https://docs.rs/tokio/0.1/tokio/runtime/struct.Builder.html">runtime <code>Builder</code></a> supports.</p>

<p>We are going to build a single threaded runtime, because it is slightly simpler
to put together. Not that the default multi threaded one would be conceptually
more complex, but there are more moving parts around. Knowing the details here
can be a stepping stone to reading the code of the default runtime.</p>

<p>A complete, working example of things discussed here can be found in the
<a href="https://github.com/tokio-rs/tokio/tree/v0.1.x/tokio/examples/manual-runtime.rs">git repository</a>.</p>

<h1 id="the-park-trait">The <code>Park</code> trait</h1>

<p>The asynchronous world is inherently about <em>waiting</em> for something to happen
(and being able to wait for multiple things at once). It is no surprise there&rsquo;s
a trait to abstract over the waiting. It&rsquo;s called <a href="https://docs.rs/tokio-executor/0.1/tokio_executor/park/trait.Park.html"><code>Park</code></a>.</p>

<p>The idea is, if there&rsquo;s nothing better to do, the control is passed to the
<code>Park</code> until something interesting happens and the control is taken away from it
again or until some specified time passes. It is up to the <code>Park</code> how it spends
this time. It can either do something useful (processing background jobs) or
simply block the thread in some way.</p>

<p>Some things are the bottom <code>Park</code> implementations ‒ they somehow block the
thread. Other things implementing the trait only delegate the park calls to some
underlying object they wrap (with some added functionality), allowing to stack
things onto each other.</p>

<h1 id="the-usual-components">The usual components</h1>

<p>We definitely need a <a href="https://docs.rs/tokio/0.1/tokio/reactor/struct.Reactor.html"><code>Reactor</code></a> to accept external events (like network sockets
being readable) from the OS. It does so by blocking on <code>epoll</code>, <code>kqueue</code> or
other OS-dependent primitive, through the <a href="https://crates.io/crates/mio">mio</a> crate. This can&rsquo;t delegate the
waiting to anything else, so the reactor goes to the bottom of our stack.</p>

<p>The reactor is able to notify our futures of data coming over the network and
similar events, but we need an executor to actually run them. We&rsquo;ll be using the
<a href="https://docs.rs/tokio-current-thread/0.1.4/tokio_current_thread/struct.CurrentThread.html"><code>CurrentThread</code></a> executor, because we&rsquo;re building a single-threaded runtime.
Use any other executor that suits your needs. The executor needs a <code>Park</code>
underneath to wait when there are no futures ready to run. It doesn&rsquo;t implement
<code>Park</code>, therefore it must go on the top of the whole stack.</p>

<p>While not strictly necessary, it is useful to be able to run delayed futures ‒
timeouts and similar. Therefore, we place the <a href="https://docs.rs/tokio-timer/0.2/tokio_timer/timer/struct.Timer.html"><code>Timer</code></a> in the middle ‒
fortunately, it can be placed on top of one <code>Park</code> and also implements <code>Park</code>.
This plays a similar role for timeouts as reactor does for IO-based futures.</p>

<p>In addition, any custom layer can be added. One example could be some kind of
idle bookkeeping component ‒ it would try to repeatedly do a bit of work if
asked to wait and interleave it with letting the park below it also pick up
events. If there was no bookkeeping to be done, it would simply delegate the
waiting.</p>

<p>This is how the creation of the reactor, timer and executor would look like in
code:</p>

<pre><code class="language-rust"># extern crate futures;
# extern crate tokio;
# extern crate tokio_executor;
# extern crate tokio_reactor;
# extern crate tokio_timer;
#
# use std::io::Error as IoError;
# use std::time::{Duration, Instant};
#
# use futures::{future, Future};
# use tokio::executor::current_thread::{self, CurrentThread};
# use tokio_reactor::Reactor;
# use tokio_timer::timer::{self, Timer};
# fn run&lt;F: Future&lt;Item = (), Error = std::io::Error&gt;&gt;(f: F) -&gt; Result&lt;(), std::io::Error&gt; {
let reactor = Reactor::new()?;
// The reactor itself will get consumed by timer,
// so we keep a handle to communicate with it.
let reactor_handle = reactor.handle();
let timer = Timer::new(reactor);
let timer_handle = timer.handle();
let mut executor = CurrentThread::new_with_park(timer);
# Ok(())
# }
# fn main() {
#      run(futures::future::lazy(|| Ok(()))).unwrap();
# }
</code></pre>

<p>This way, if there are futures to execute, they&rsquo;ll get executed first. Then once
it runs out of ready futures, it&rsquo;ll look for timeouts to fire. This may generate
some more ready futures (which would get executed next). If no timeouts fire,
the timer computes for how long the reactor can safely block and lets it wait
for external events.</p>

<h1 id="global-state">Global state</h1>

<p>We&rsquo;ve built the components that do the actual work. But we need a way to build
and submit the work to them. We could do so through the handles, but to do that,
we would have to carry them around which would be far from ergonomic.</p>

<p>To avoid the tedious passing of several handles around, the built-in runtime
stores them in a thread local storage. Several modules in tokio have a
<code>with_default</code> method, which takes the corresponding handle and a closure. It
stores the handle in the thread local storage and runs the closure. It then
restores the original value of the TLS after the closure finishes.</p>

<p>This way we would run a future with all the default values set, so it can freely
use them:</p>

<pre><code class="language-rust"># extern crate futures;
# extern crate tokio;
# extern crate tokio_executor;
# extern crate tokio_reactor;
# extern crate tokio_timer;
#
# use std::io::Error as IoError;
# use std::time::{Duration, Instant};
#
# use futures::{future, Future};
# use tokio::executor::current_thread::{self, CurrentThread};
# use tokio_reactor::Reactor;
# use tokio_timer::timer::{self, Timer};
# fn run&lt;F: Future&lt;Item = (), Error = std::io::Error&gt;&gt;(f: F) -&gt; Result&lt;(), std::io::Error&gt; {
# let reactor = Reactor::new()?;
# let reactor_handle = reactor.handle();
# let timer = Timer::new(reactor);
# let timer_handle = timer.handle();
# let mut executor = CurrentThread::new_with_park(timer);
// Binds an executor to this thread
let mut enter = tokio_executor::enter()
    .expect(&quot;Multiple executors at once&quot;);
// Set the defaults before running the closure
let result = tokio_reactor::with_default(
    &amp;reactor_handle,
    &amp;mut enter,
    |enter| timer::with_default(
        &amp;timer_handle,
        enter,
        |enter| {
            let mut default_executor =
                current_thread::TaskExecutor::current();
            tokio_executor::with_default(
                &amp;mut default_executor,
                enter,
                |enter| executor.enter(enter).block_on(f)
            )
        }
    )
);
# Ok(())
# }
# fn main() {
#      run(futures::future::lazy(|| Ok(()))).unwrap();
# }
</code></pre>

<p>There are a few things of note. First, the <code>enter</code> thing just ensures that we
don&rsquo;t run multiple executors on the same thread at the same time. Running
multiple executors would get one of them blocked, which would act in a very not
useful way, therefore this is footgun prevention.</p>

<p>Second, we want to use the same executor as the default executor and default
current thread executor, and also to run the executor (not only spawn a future
onto it without further waiting). To do both, we need two mutable references to
it, which is not possible. To work around that, we set the current thread
executor (it actually sets itself, in the <code>executor.block_on</code> call, or any
similar one). We use the <code>TaskExecutor</code> as the default one, which is a proxy to
whatever current thread executor is configured at the time of its use.</p>

<p>Finally, the <code>block_on</code> will execute the single future to completion (and will
process any other futures spawned in the executor as well, but it&rsquo;ll not wait
for them to finish if <code>f</code> finishes first). The result of the future is bubbled
upwards through all the <code>with_default</code> calls and can be returned or used in any
other way. If you want to wait for all the other futures to finish too, there&rsquo;s
also <code>executor.run</code> which can be executed afterwards.</p>

      
      
        <div class="tk-next">
          <b>Next up</b>: <a href ="/docs/internals/intro/">Introduction</a>
        </div>
      
    </main>
  </div>
</div>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://mindfreeze.videolan.me/rav1e/js/bootstrap.min.js"></script>
    <script src="https://mindfreeze.videolan.me/rav1e/js/highlight.js"></script>
    <script>
      $(function () {
        $("pre code").each(function(i, block) {
          
          if (block.className.indexOf('language-rust') >= 0) {
            var new_content = '';
            var lines = block.textContent.split('\n');
            for (var i = 0; i < lines.length; i++) {
              if (lines[i].indexOf('# ') == 0 || lines[i] == '#') {
                continue
              }
              new_content += lines[i].trimRight() + '\n';
            }
            block.textContent = new_content.replace(/\n\n\n/g, "\n\n").trimRight();
          }
          hljs.highlightBlock(block);
        });
      });
    </script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script type="text/javascript"> docsearch({
    apiKey: 'd7b5b785798fe748621bcaa8301a2201',
    indexName: 'tokio',
    inputSelector: '#search-input',
    debug: false 
    });
    </script>
    
  </body>
</html>

